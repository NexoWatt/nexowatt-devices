<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title class="translate">nexowatt-devices</title>

  <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">
  <link rel="stylesheet" type="text/css" href="../../css/adapter.css">
  <link rel="stylesheet" type="text/css" href="style.css">

  <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
  <script type="text/javascript" src="../../js/translate.js"></script>
  <script type="text/javascript" src="../../lib/js/materialize.js"></script>
  <script type="text/javascript" src="../../js/adapter-settings.js"></script>
  <script type="text/javascript" src="words.js"></script>

  <script type="text/javascript" src="index_m.js"></script>
</head>

<body>
<div class="m adapter-container">

  <!-- Header -->
  <div class="row">
    <div class="col s12">
      <div class="card nexo-header">
        <div class="card-content">
          <div class="nexo-header-row">
            <span class="card-title nexo-title translate">Nexowatt Devices</span>
            <span class="nexo-badge">nexowatt-devices</span>
          </div>
          <p class="nexo-subtitle translate">Standalone multi-protocol device adapter with categories and driver templates (Modbus TCP/RTU, MQTT, HTTP).</p>
          <p class="nexo-meta">
            <span class="translate">Treiber geladen:</span>
            <span id="tplCount">…</span>
          </p>
          <p class="nexo-hint">
            <span class="translate">Hinweis: Änderungen an Geräten werden erst nach dem Speichern (oben) und anschließendem Neustart der Instanz aktiv.</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Global settings -->
  <div class="row">
    <div class="col s12">
      <div class="card">
        <div class="card-content">
          <span class="card-title translate">Globale Einstellungen</span>

          <div class="row">
            <div class="input-field col s12 m4">
              <input class="value" id="pollIntervalMs" type="number" min="250" step="50"/>
              <label for="pollIntervalMs" class="translate">Polling Intervall (ms)</label>
            </div>

            <div class="input-field col s12 m4">
              <input class="value" id="modbusTimeoutMs" type="number" min="250" step="50"/>
              <label for="modbusTimeoutMs" class="translate">Modbus Timeout (ms)</label>
            </div>

            <div class="input-field col s12 m4">
              <input class="value" id="registerAddressOffset" type="number" step="1"/>
              <label for="registerAddressOffset" class="translate">Register Address Offset (z.B. -1 für 1-basierte Geräte)</label>
            </div>
          </div>

          <div class="row">
            <div class="col s12">
              <textarea class="value" id="devicesJson" style="display:none;"></textarea>
              <p class="grey-text text-darken-1">
                <span class="translate">Die Geräte-Konfiguration wird intern als JSON gespeichert.</span>
                <a href="#!" id="btnShowJson" class="translate">JSON anzeigen</a>
              </p>
              <pre id="jsonPreview" class="nexo-json-preview" style="display:none;"></pre>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Devices -->
  <div class="row">
    <div class="col s12">
      <div class="card">
        <div class="card-content">
          <div class="nexo-devices-header">
            <span class="card-title translate">Geräte</span>
            <a class="waves-effect waves-light btn" id="btnAddDevice" href="#!">
              <span class="nexo-icon">+</span>
              <span class="translate">Gerät hinzufügen</span>
            </a>
          </div>

          <div class="row">
            <div class="col s12">
              <table class="highlight responsive-table nexo-table" id="devicesTable">
                <thead>
                  <tr>
                    <th class="translate">Aktiv</th>
                    <th class="translate">ID</th>
                    <th class="translate">Name</th>
                    <th class="translate">Kategorie</th>
                    <th class="translate">Treiber</th>
                    <th class="translate">Protokoll</th>
                    <th class="translate">Verbindung</th>
                    <th class="translate">Aktionen</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <p class="grey-text text-darken-1" id="noDevicesHint" style="display:none;">
                <span class="translate">Noch keine Geräte konfiguriert.</span>
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Modal backdrop for fallback mode (only used if Materialize JS is not available) -->
  <div id="nexoBackdrop" class="nexo-backdrop" style="display:none;"></div>

  <!-- Modal: Add/Edit device -->
  <div id="modalDevice" class="modal modal-fixed-footer nexo-modal">
    <div class="modal-content">
      <h5 id="modalTitle" class="translate">Gerät</h5>

      <div class="row">
        <div class="input-field col s12 m4">
          <input id="dev_id" type="text" />
          <label for="dev_id" class="translate">Geräte-ID (eindeutig, z.B. evcs1)</label>
        </div>
        <div class="input-field col s12 m8">
          <input id="dev_name" type="text" />
          <label for="dev_name" class="translate">Name (frei wählbar)</label>
        </div>
      </div>

      <div class="row nexo-select-row">
        <div class="col s12 m4 nexo-select-group">
          <label for="dev_category" class="translate">Kategorie</label>
          <select id="dev_category" class="browser-default"></select>
        </div>
        <div class="col s12 m4 nexo-select-group">
          <label for="dev_manufacturer" class="translate">Hersteller</label>
          <select id="dev_manufacturer" class="browser-default"></select>
        </div>
        <div class="col s12 m4 nexo-select-group">
          <label for="dev_template" class="translate">Treiber/Template</label>
          <select id="dev_template" class="browser-default"></select>
        </div>
      </div>

      <div class="row nexo-select-row">
        <div class="col s12 m4 nexo-select-group">
          <label for="dev_protocol" class="translate">Protokoll</label>
          <select id="dev_protocol" class="browser-default"></select>
        </div>
        <div class="input-field col s12 m4">
          <input id="dev_poll" type="number" min="250" step="50" />
          <label for="dev_poll" class="translate">Polling Intervall (ms, optional)</label>
        </div>
        <div class="input-field col s12 m4">
          <div class="switch">
            <label>
              <span class="translate">Inaktiv</span>
              <input id="dev_enabled" type="checkbox" checked>
              <span class="lever"></span>
              <span class="translate">Aktiv</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Connection blocks -->
      <div id="conn_modbusTcp" class="nexo-conn-block" style="display:none;">
        <h6 class="translate">Modbus TCP Verbindung</h6>
        <div class="row">
          <div class="input-field col s12 m4">
            <input id="mb_host" type="text" />
            <label for="mb_host" class="translate">Host/IP</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="mb_port" type="number" min="1" max="65535" />
            <label for="mb_port" class="translate">Port</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="mb_unitId" type="number" min="1" max="247" />
            <label for="mb_unitId" class="translate">Unit-ID</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="mb_timeout" type="number" min="250" step="50" />
            <label for="mb_timeout" class="translate">Timeout (ms)</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="mb_addrOffset" type="number" step="1" />
            <label for="mb_addrOffset" class="translate">Addr-Offset</label>
          </div>
        </div>

        <div class="row">
          <div class="col s12 m3 nexo-select-group">
            <label for="mb_wordOrder" class="translate">Word Order</label>
            <select id="mb_wordOrder" class="browser-default">
              <option value="be">BE</option>
              <option value="le">LE</option>
            </select>
          </div>
          <div class="col s12 m3 nexo-select-group">
            <label for="mb_byteOrder" class="translate">Byte Order</label>
            <select id="mb_byteOrder" class="browser-default">
              <option value="be">BE</option>
              <option value="le">LE</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12 m4">
            <input id="mb_writePass" type="password" />
            <label for="mb_writePass" class="translate">Schreibpasswort (optional)</label>
          </div>
        </div>
      </div>

      <div id="conn_modbusRtu" class="nexo-conn-block" style="display:none;">
        <h6 class="translate">Modbus RTU Verbindung</h6>
        <div class="row">
          <div class="input-field col s12 m4">
            <input id="mb_path" type="text" />
            <label for="mb_path" class="translate">Serial Port (z.B. /dev/com2)</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="mb_baud" type="number" min="1200" step="300" />
            <label for="mb_baud" class="translate">Baudrate</label>
          </div>
          <div class="col s12 m2 nexo-select-group">
            <label for="mb_parity" class="translate">Parity</label>
            <select id="mb_parity" class="browser-default">
              <option value="none">none</option>
              <option value="even">even</option>
              <option value="odd">odd</option>
            </select>
          </div>
          <div class="input-field col s12 m2">
            <input id="mb_databits" type="number" min="5" max="8" />
            <label for="mb_databits" class="translate">DataBits</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="mb_stopbits" type="number" min="1" max="2" />
            <label for="mb_stopbits" class="translate">StopBits</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12 m2">
            <input id="mb_unitId_rtu" type="number" min="1" max="247" />
            <label for="mb_unitId_rtu" class="translate">Unit-ID</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="mb_timeout_rtu" type="number" min="250" step="50" />
            <label for="mb_timeout_rtu" class="translate">Timeout (ms)</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="mb_addrOffset_rtu" type="number" step="1" />
            <label for="mb_addrOffset_rtu" class="translate">Addr-Offset</label>
          </div>
          <div class="col s12 m3 nexo-select-group">
            <label for="mb_wordOrder_rtu" class="translate">Word Order</label>
            <select id="mb_wordOrder_rtu" class="browser-default">
              <option value="be">BE</option>
              <option value="le">LE</option>
            </select>
          </div>
          <div class="col s12 m3 nexo-select-group">
            <label for="mb_byteOrder_rtu" class="translate">Byte Order</label>
            <select id="mb_byteOrder_rtu" class="browser-default">
              <option value="be">BE</option>
              <option value="le">LE</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12 m4">
            <input id="mb_writePass_rtu" type="password" />
            <label for="mb_writePass_rtu" class="translate">Schreibpasswort (optional)</label>
          </div>
        </div>
      </div>

      <div id="conn_mqtt" class="nexo-conn-block" style="display:none;">
        <h6 class="translate">MQTT Verbindung</h6>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="mqtt_url" type="text" />
            <label for="mqtt_url" class="translate">Broker URL (mqtt://host:1883)</label>
          </div>
          <div class="input-field col s12 m3">
            <input id="mqtt_user" type="text" />
            <label for="mqtt_user" class="translate">Username</label>
          </div>
          <div class="input-field col s12 m3">
            <input id="mqtt_pass" type="password" />
            <label for="mqtt_pass" class="translate">Password</label>
          </div>
        </div>
      </div>

      <div id="conn_http" class="nexo-conn-block" style="display:none;">
        <h6 class="translate">HTTP/JSON Verbindung</h6>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="http_baseUrl" type="text" />
            <label for="http_baseUrl" class="translate">Base URL (http://host)</label>
          </div>
          <div class="input-field col s12 m3">
            <input id="http_user" type="text" />
            <label for="http_user" class="translate">Username</label>
          </div>
          <div class="input-field col s12 m3">
            <input id="http_pass" type="password" />
            <label for="http_pass" class="translate">Password</label>
          </div>
        </div>
      </div>

      <div id="conn_udp" class="nexo-conn-block" style="display:none;">
        <h6 class="translate">UDP Verbindung</h6>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="udp_host" type="text" />
            <label for="udp_host" class="translate">Host/IP</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="udp_port" type="number" min="1" max="65535" />
            <label for="udp_port" class="translate">Port</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="udp_timeout" type="number" min="100" step="50" />
            <label for="udp_timeout" class="translate">Timeout (ms)</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="udp_pause" type="number" min="0" step="10" />
            <label for="udp_pause" class="translate">Cmd Pause (ms)</label>
          </div>
        </div>
      </div>

      <div id="conn_speedwire" class="nexo-conn-block" style="display:none;">
        <h6 class="translate">Speedwire (UDP Multicast)</h6>
        <div class="row">
          <div class="input-field col s12 m4">
            <input id="sw_filterHost" type="text" />
            <label for="sw_filterHost" class="translate">Gerät-IP (Filter, optional)</label>
          </div>
          <div class="input-field col s12 m4">
            <input id="sw_multicastGroup" type="text" />
            <label for="sw_multicastGroup" class="translate">Multicast Gruppe</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="sw_port" type="number" min="1" max="65535" />
            <label for="sw_port" class="translate">Port</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="sw_stale" type="number" min="0" step="100" />
            <label for="sw_stale" class="translate">Stale Timeout (ms)</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m4">
            <input id="sw_interface" type="text" />
            <label for="sw_interface" class="translate">Interface IP (optional)</label>
          </div>
          <div class="col s12 m8 nexo-muted" style="margin-top: 12px; font-size: 0.9em;">
            <span class="translate">Hinweis</span>: <span class="translate">Speedwire nutzt UDP Multicast. In VLAN/WiFi/Virtualisierung muss Multicast (IGMP) durchgelassen werden.</span>
          </div>
        </div>
      </div>

      <!-- Datapoints preview -->
      <div class="row">
        <div class="col s12">
          <h6 class="translate">Datenpunkte</h6>
          <table class="striped dp-table">
            <thead>
              <tr>
                <th class="translate">ID</th>
                <th class="translate">Name</th>
                <th class="translate">Typ</th>
                <th class="translate">R/W</th>
                <th class="translate">Quelle</th>
              </tr>
            </thead>
            <tbody id="dpBody"></tbody>
          </table>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <a href="#!" class="waves-effect waves-light btn-flat" id="btnCancelDevice"><span class="translate">Abbrechen</span></a>
      <a href="#!" class="waves-effect waves-light btn" id="btnSaveDevice"><span class="translate">Speichern</span></a>
    </div>
  </div>

</div>
</body>
</html>
